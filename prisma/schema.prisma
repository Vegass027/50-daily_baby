// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Модель для хранения состояния торговой панели пользователя
model UserPanelState {
  userId              BigInt    @id  // BigInt для Telegram IDs
  messageId           Int
  tokenAddress        String
  mode                PanelMode
  tokenData           String    // JSON as string
  userData            String    // JSON as string
  actionData          String    // JSON as string
  activeLimitOrderId   String?
  waitingFor          String?
  closed              Boolean   @default(false)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

// Модель для отслеживания торговых позиций
model Position {
  id           String        @id @default(cuid())
  userId       BigInt        // BigInt для Telegram IDs
  tokenAddress String
  entryPrice   Float // Средняя цена входа
  size         Float // Текущий размер позиции в токенах
  trades       Trade[]
  linkedOrders LinkedOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, tokenAddress])
}

// Модель для хранения лимитных ордеров
model Order {
  id          String     @id @default(cuid())
  userId      BigInt     // Telegram ID пользователя
  type        String     // "LIMIT", "TAKE_PROFIT", "STOP_LOSS"
  side        String     // "BUY" или "SELL"
  tokenMint   String
  amount      Float      // Количество в SOL или токенах
  price       Float      // Целевая цена
  status      String     // "PENDING", "FILLED", "CANCELLED"
  filledPrice Float?     // Цена исполнения
  filledAmount Float?     // Количество исполнения
  params      String     // JSON параметры ордера
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Модель для хранения истории сделок (покупок и продаж)
model Trade {
  id         String     @id @default(cuid())
  position   Position   @relation(fields: [positionId], references: [id])
  positionId String
  type       TradeType
  price      Float
  size       Float // Количество токенов в сделке
  timestamp  DateTime   @default(now())
}

// Модель для связи TP/SL ордеров с основной позицией
model LinkedOrder {
  id          String   @id @default(cuid())
  position    Position @relation(fields: [positionId], references: [id])
  positionId  String   @unique
  tpOrderId   String? // ID ордера на Take Profit
  slOrderId   String? // ID ордера на Stop Loss
  orderType   String // "pumpfun" или "jupiter"
  createdAt   DateTime @default(now())
}

// --- Enums ---

enum PanelMode {
  BUY
  SELL
  LIMIT
  TRACK
}

enum TradeType {
  BUY
  SELL
}