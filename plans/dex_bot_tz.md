# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: –¢–æ—Ä–≥–æ–≤–∞—è –ø–∞–Ω–µ–ª—å DEX-–±–æ—Ç–∞ –≤ Telegram

## –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ—Ä–≥–æ–≤—É—é –ø–∞–Ω–µ–ª—å –¥–ª—è DEX-–±–æ—Ç–∞ –≤ Telegram, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É **–µ–¥–∏–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç–æ–∫–µ–Ω–∞** —Å –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—ã–º–∏ —Ä–µ–∂–∏–º–∞–º–∏ —Ä–∞–±–æ—Ç—ã. –ü–∞–Ω–µ–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ Telegram Bot API —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º inline-–∫–Ω–æ–ø–æ–∫ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π.

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ:** –ü–∞–Ω–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –±–æ—Ç—É –∞–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ —Ç–æ–∫–µ–Ω–∞ –≤ —á–∞—Ç (–±–µ–∑ –∫–æ–º–∞–Ω–¥—ã `/trade`).

---

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã
–í—Å—è —Ç–æ—Ä–≥–æ–≤–∞—è –ø–∞–Ω–µ–ª—å ‚Äî —ç—Ç–æ **–æ–¥–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** –≤ Telegram —Å:
- –¢–µ–∫—Å—Ç–æ–≤—ã–º –±–ª–æ–∫–æ–º (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
- Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)

–ü—Ä–∏ –ª—é–±–æ–º –¥–µ–π—Å—Ç–≤–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
1. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è callback
2. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
3. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
4. **–ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–æ–∫–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ —Å–µ—Å—Å–∏–∏**

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (State)

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ö—Ä–∞–Ω–∏—Ç—å:

```python
user_state = {
    "user_id": int,
    "message_id": int,  # ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–∞–Ω–µ–ª—å—é
    "token_address": str,  # –ê–¥—Ä–µ—Å —Ç–µ–∫—É—â–µ–≥–æ —Ç–æ–∫–µ–Ω–∞
    "mode": str,  # "buy" | "sell" | "limit" | "track"
    "token_data": {
        "name": str,
        "ticker": str,
        "market_cap": float,
        "liquidity": float,
        "current_price": float
    },
    "user_data": {
        "sol_balance": float,
        "usd_balance": float,
        "has_active_order": bool
    },
    "action_data": {
        # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
        "selected_amount": float,
        "slippage": float,
        "limit_price": float,
        "position": dict
    }
}
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

### 1. –¢–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π)

–§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π `generate_panel_text(user_state)` –∏ –≤–∫–ª—é—á–∞–µ—Ç:

#### –ë–ª–æ–∫ Header (–≤—Å–µ–≥–¥–∞)
```
ü™ô {token_name} ({ticker})
üìù {short_contract_address}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
```

#### –ë–ª–æ–∫ Token Info (–≤—Å–µ–≥–¥–∞)
```
üìä Market Cap: ${market_cap}
üíß Liquidity: ${liquidity}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
```

#### –ë–ª–æ–∫ User Info (–≤—Å–µ–≥–¥–∞)
```
üíº Balance: {sol_balance} SOL (${usd_balance})
üìå Active Order: {Yes/No}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
```

#### –ë–ª–æ–∫ Action Area (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∂–∏–º–∞)

**–î–ª—è —Ä–µ–∂–∏–º–∞ Buy:**
```
üí∞ Quick Buy
Selected: ${amount} USD
Slippage: {slippage}%
```

**–î–ª—è —Ä–µ–∂–∏–º–∞ Sell:**
```
üí∏ Quick Sell
Amount: {amount} tokens
Slippage: {slippage}%
```

**–î–ª—è —Ä–µ–∂–∏–º–∞ Limit:**
```
‚è≥ Limit Order
Target Price: ${limit_price}
Amount: ${amount}
Status: {Active/Inactive}
```

**–î–ª—è —Ä–µ–∂–∏–º–∞ Track:**
```
üìà Position Tracking
Entry: ${entry_price}
Current: ${current_price}
Size: {position_size} tokens
PNL: ${pnl_usd} ({pnl_percent}%)
```

---

### 2. Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è)

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π `generate_keyboard(user_state)`.

#### –†–µ–∂–∏–º–Ω–∞—è –ø–∞–Ω–µ–ª—å (–≤—Å–µ–≥–¥–∞ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)
```
[‚úÖ Buy] [Sell] [Limit] [Track]
```
- –ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º: ‚úÖ –∏–ª–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —á–µ—Ä–µ–∑ emoji
- Callback data: `mode:buy`, `mode:sell`, `mode:limit`, `mode:track`

#### Action-–∫–Ω–æ–ø–∫–∏ (–∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ä–µ–∂–∏–º–∞)

**–î–ª—è Buy/Sell:**
```
[$10] [$50] [$100]
[Slippage: 1%] [Gas: Auto]
[üü¢ Execute Trade]
```

**–î–ª—è Limit:**
```
[Set Price] [Set Amount]
[üìç Place Order] or [‚ùå Cancel Order]
```

**–î–ª—è Track:**
```
[üîÑ Refresh] [üìä Chart]
```

#### –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (–≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞)
```
[üîÑ Refresh Data] [‚ùå Close Panel]
```

---

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ (–ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï)

**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ —á–∞—Ç —Ç–µ–∫—Å—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∞–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ Solana

**–ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞:**
1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –≤–∞–ª–∏–¥–Ω—ã–º –∞–¥—Ä–µ—Å–æ–º Solana (base58, –¥–ª–∏–Ω–∞ 32-44 —Å–∏–º–≤–æ–ª–∞)
3. –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω–∞ –ø–æ —ç—Ç–æ–º—É –∞–¥—Ä–µ—Å—É
4. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å
5. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É

**–í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ Solana:**
```python
import base58

def is_valid_solana_address(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤–∞–ª–∏–¥–Ω—ã–º –∞–¥—Ä–µ—Å–æ–º Solana
    """
    try:
        # –£–±—Ä–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã
        text = text.strip()
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–ª–∏–Ω—É (–æ–±—ã—á–Ω–æ 32-44 —Å–∏–º–≤–æ–ª–∞)
        if len(text) < 32 or len(text) > 44:
            return False
        
        # –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å base58
        decoded = base58.b58decode(text)
        
        # –ê–¥—Ä–µ—Å Solana –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 32 –±–∞–π—Ç–∞
        if len(decoded) != 32:
            return False
            
        return True
    except:
        return False
```

**–ü—Ä–æ—Ü–µ—Å—Å –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏:**

```python
async def handle_message(update, context):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    """
    text = update.message.text
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –∞–¥—Ä–µ—Å–æ–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
    if not is_valid_solana_address(text):
        return  # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∞–¥—Ä–µ—Å
    
    token_address = text.strip()
    
    # –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    loading_msg = await update.message.reply_text("‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–∞...")
    
    try:
        # –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω–∞
        token_data = await fetch_token_data(token_address)
        
        if not token_data:
            await loading_msg.edit_text("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–¥—Ä–µ—Å")
            return
        
        # –°–æ–∑–¥–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_state = create_user_state(
            user_id=user_id,
            token_address=token_address,
            token_data=token_data
        )
        
        # –ó–∞–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ø–∞–Ω–µ–ª—å
        await loading_msg.edit_text(
            text=generate_panel_text(user_state),
            reply_markup=generate_keyboard(user_state)
        )
        
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å message_id
        user_state["message_id"] = loading_msg.message_id
        save_user_state(user_state)
        
    except Exception as e:
        logger.error(f"Error loading token: {e}")
        await loading_msg.edit_text("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º:**

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–¥—Ä–µ—Å —Å—Ä–µ–¥–∏ –¥—Ä—É–≥–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:

```python
import re

def extract_solana_address(text: str) -> str | None:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∞–¥—Ä–µ—Å Solana –∏–∑ —Ç–µ–∫—Å—Ç–∞
    """
    # –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è base58 –∞–¥—Ä–µ—Å–æ–≤ (–±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã, –±–µ–∑ 0, O, I, l)
    pattern = r'\b[1-9A-HJ-NP-Za-km-z]{32,44}\b'
    
    matches = re.findall(pattern, text)
    
    for match in matches:
        if is_valid_solana_address(match):
            return match
    
    return None

async def handle_message(update, context):
    text = update.message.text
    
    # –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏–∑–≤–ª–µ—á—å –∞–¥—Ä–µ—Å
    token_address = extract_solana_address(text)
    
    if not token_address:
        return  # –≠—Ç–æ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–µ –∞–¥—Ä–µ—Å
    
    # ... –¥–∞–ª–µ–µ –ª–æ–≥–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏
```

---

### –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤

**Callback pattern:** `mode:{mode_name}`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ò–∑–º–µ–Ω–∏—Ç—å `user_state["mode"]`
3. –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å–æ–æ–±—â–µ–Ω–∏—è
4. **–ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–æ–∫–µ–Ω–∞ –ù–ï –º–µ–Ω—è–µ—Ç—Å—è**

```python
async def handle_mode_switch(update, context):
    query = update.callback_query
    new_mode = query.data.split(":")[1]
    
    user_state = get_user_state(query.from_user.id)
    user_state["mode"] = new_mode
    
    await query.edit_message_text(
        text=generate_panel_text(user_state),
        reply_markup=generate_keyboard(user_state)
    )
    
    save_user_state(user_state)
    await query.answer()  # –£–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏" –∑–∞–≥—Ä—É–∑–∫–∏
```

---

### –î–µ–π—Å—Ç–≤–∏—è –≤ —Ä–µ–∂–∏–º–∞—Ö

#### Buy/Sell —Ä–µ–∂–∏–º

**Callback patterns:**
- `amount:{value}` ‚Äî –≤—ã–±–æ—Ä —Å—É–º–º—ã
- `slippage:{value}` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ slippage
- `execute:buy` / `execute:sell` ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏

**–ü—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏:**
1. –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: "‚è≥ Processing..."
2. –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (Jupiter Swap API)
3. –ü–æ–¥–ø–∏—Å–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
4. –ñ–¥–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
5. –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º

```python
async def handle_execute_trade(update, context):
    query = update.callback_query
    user_state = get_user_state(query.from_user.id)
    
    # –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
    await query.answer("‚è≥ Processing trade...")
    
    try:
        # –í—ã–ø–æ–ª–Ω–∏—Ç—å swap
        tx_signature = await execute_swap(
            token_address=user_state["token_address"],
            amount=user_state["action_data"]["selected_amount"],
            slippage=user_state["action_data"]["slippage"],
            action=user_state["mode"]  # "buy" or "sell"
        )
        
        # –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        await refresh_user_balances(user_state)
        
        # –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—Ö
        await query.answer(f"‚úÖ Trade completed! TX: {tx_signature[:8]}...")
        
        # –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
        await query.edit_message_text(
            text=generate_panel_text(user_state),
            reply_markup=generate_keyboard(user_state)
        )
        
    except Exception as e:
        await query.answer(f"‚ùå Error: {str(e)}", show_alert=True)
```

---

#### Limit —Ä–µ–∂–∏–º

**Callback patterns:**
- `limit:set_price` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ–Ω—ã
- `limit:set_amount` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—É–º–º—ã
- `limit:place` ‚Äî —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ—Ä–¥–µ—Ä
- `limit:cancel` ‚Äî –æ—Ç–º–µ–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥:**

```python
async def handle_set_limit_price(update, context):
    query = update.callback_query
    user_state = get_user_state(query.from_user.id)
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
    user_state["waiting_for"] = "limit_price"
    save_user_state(user_state)
    
    await query.answer()
    await context.bot.send_message(
        chat_id=query.from_user.id,
        text="üíµ –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–µ–≤—É—é —Ü–µ–Ω—É –≤ USD:"
    )

async def handle_text_input(update, context):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –≤–≤–æ–¥–æ–≤ (—Ü–µ–Ω–∞, —Å—É–º–º–∞)
    """
    user_state = get_user_state(update.effective_user.id)
    
    # –ï—Å–ª–∏ –Ω–µ –∂–¥–µ–º –≤–≤–æ–¥–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∞–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞
    if not user_state.get("waiting_for"):
        # –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞
        await handle_message(update, context)
        return
    
    waiting_for = user_state["waiting_for"]
    
    if waiting_for == "limit_price":
        try:
            price = float(update.message.text)
            user_state["action_data"]["limit_price"] = price
            user_state["waiting_for"] = None
            
            # –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
            await context.bot.edit_message_text(
                chat_id=update.effective_user.id,
                message_id=user_state["message_id"],
                text=generate_panel_text(user_state),
                reply_markup=generate_keyboard(user_state)
            )
            
            await update.message.reply_text("‚úÖ –¶–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
            
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞")
```

**–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–∞:**
1. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (—Ü–µ–Ω–∞, —Å—É–º–º–∞)
2. –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
3. –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ü–µ–Ω—ã
4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ –ø–∞–Ω–µ–ª–∏

```python
async def handle_place_limit_order(update, context):
    query = update.callback_query
    user_state = get_user_state(query.from_user.id)
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ª–∏ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    if not user_state["action_data"].get("limit_price"):
        await query.answer("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ü–µ–Ω—É", show_alert=True)
        return
    
    if not user_state["action_data"].get("selected_amount"):
        await query.answer("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å—É–º–º—É", show_alert=True)
        return
    
    order = {
        "user_id": user_state["user_id"],
        "token_address": user_state["token_address"],
        "target_price": user_state["action_data"]["limit_price"],
        "amount": user_state["action_data"]["selected_amount"],
        "status": "active",
        "created_at": datetime.now()
    }
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä
    order_id = await create_limit_order(order)
    
    # –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    user_state["user_data"]["has_active_order"] = True
    user_state["action_data"]["order_id"] = order_id
    
    await query.answer("‚úÖ –õ–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω")
    
    # –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
    await query.edit_message_text(
        text=generate_panel_text(user_state),
        reply_markup=generate_keyboard(user_state)
    )
```

---

#### Track —Ä–µ–∂–∏–º

**Callback patterns:**
- `track:refresh` ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
- `track:chart` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–æ—Ü–µ—Å—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–¥–µ–ª–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –≤—Ö–æ–¥–∞
3. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É —Ç–æ–∫–µ–Ω–∞
4. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å PNL
5. –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

```python
async def handle_track_mode(user_state):
    # –ü–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    position = await get_user_position(
        user_id=user_state["user_id"],
        token_address=user_state["token_address"]
    )
    
    if not position:
        user_state["action_data"]["position"] = None
        return
    
    # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å PNL
    current_price = user_state["token_data"]["current_price"]
    entry_value = position["entry_price"] * position["size"]
    current_value = current_price * position["size"]
    
    pnl_usd = current_value - entry_value
    pnl_percent = (pnl_usd / entry_value) * 100 if entry_value > 0 else 0
    
    user_state["action_data"]["position"] = {
        "entry_price": position["entry_price"],
        "current_price": current_price,
        "size": position["size"],
        "pnl_usd": pnl_usd,
        "pnl_percent": pnl_percent
    }
```

---

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (websocket/polling)

–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¥–ª—è –∫–∞–∂–¥–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏:

```python
async def auto_refresh_panel(user_state):
    """
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    """
    while panel_is_active(user_state):
        try:
            # –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω–∞
            token_data = await fetch_token_data(user_state["token_address"])
            user_state["token_data"] = token_data
            
            # –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await refresh_user_balances(user_state)
            
            # –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω —Ä–µ–∂–∏–º Track, –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
            if user_state["mode"] == "track":
                await handle_track_mode(user_state)
            
            # –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç)
            await bot.edit_message_text(
                chat_id=user_state["user_id"],
                message_id=user_state["message_id"],
                text=generate_panel_text(user_state),
                reply_markup=generate_keyboard(user_state)
            )
            
        except Exception as e:
            logger.error(f"Auto-refresh error: {e}")
        
        await asyncio.sleep(5)  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥

def panel_is_active(user_state):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ –ø–∞–Ω–µ–ª—å
    """
    # –ü–∞–Ω–µ–ª—å –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª –µ–µ –∏–ª–∏ –ø—Ä–æ—à–ª–æ > 1 —á–∞—Å–∞
    if user_state.get("closed"):
        return False
    
    created_at = user_state.get("created_at")
    if created_at and (datetime.now() - created_at).seconds > 3600:
        return False
    
    return True
```

### –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

**Callback:** `refresh:data`

–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–∞–Ω–µ–ª–∏.

```python
async def handle_refresh(update, context):
    query = update.callback_query
    user_state = get_user_state(query.from_user.id)
    
    await query.answer("üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...")
    
    # –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    token_data = await fetch_token_data(user_state["token_address"])
    user_state["token_data"] = token_data
    
    await refresh_user_balances(user_state)
    
    if user_state["mode"] == "track":
        await handle_track_mode(user_state)
    
    # –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
    await query.edit_message_text(
        text=generate_panel_text(user_state),
        reply_markup=generate_keyboard(user_state)
    )
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
- **–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∞–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞:** –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É, –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–∞–Ω–µ–ª—å
- **–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω:** "‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å."
- **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞:** –ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Å–¥–µ–ª–∫–∏
- **–û—à–∏–±–∫–∞ RPC:** –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "‚ö†Ô∏è Network error. Try again."
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞:** –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É, –æ—Ç–∫–∞—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∫–æ–¥–µ

```python
try:
    result = await execute_swap(...)
except InsufficientFundsError:
    await query.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤", show_alert=True)
except RPCError as e:
    await query.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", show_alert=True)
    logger.error(f"RPC error: {e}")
except TransactionError as e:
    await query.answer(f"‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞: {e}", show_alert=True)
except Exception as e:
    logger.error(f"Trade error: {e}")
    await query.answer("‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏", show_alert=True)
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
1. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫:** –î–ª—è —Å—É–º–º > $100 –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å alert —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
2. **Rate limiting:** –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫ (–º–∞–∫—Å 1 –≤ 3 —Å–µ–∫—É–Ω–¥—ã)
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è callback data:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ callback –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
4. **–•—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (AES-256)
5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–æ–≤:** –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∞–¥—Ä–µ—Å–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

```python
def validate_callback(query, user_state):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ callback –≤—ã–ø–æ–ª–Ω–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    """
    if query.from_user.id != user_state["user_id"]:
        raise PermissionError("Unauthorized callback")
    
    if query.message.message_id != user_state["message_id"]:
        raise ValueError("Invalid message context")

async def confirm_large_trade(query, amount_usd):
    """
    –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å—É–º–º
    """
    if amount_usd > 100:
        # –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        await query.answer(
            f"‚ö†Ô∏è –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —Å–æ–≤–µ—Ä—à–∏—Ç—å —Å–¥–µ–ª–∫—É –Ω–∞ ${amount_usd}. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.",
            show_alert=True
        )
        # TODO: –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
```

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–î–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω–æ–≤:** –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 30 —Å–µ–∫—É–Ω–¥ (Redis)
- **–ë–∞–ª–∞–Ω—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 10 —Å–µ–∫—É–Ω–¥
- **RPC calls:** Batch requests –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ

```python
from functools import lru_cache
from datetime import datetime, timedelta

# –ü—Ä–æ—Å—Ç–æ–π –∫—ç—à –≤ –ø–∞–º—è—Ç–∏
cache = {}

async def fetch_token_data_cached(token_address: str):
    """
    –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    """
    cache_key = f"token:{token_address}"
    
    if cache_key in cache:
        cached_data, cached_time = cache[cache_key]
        if datetime.now() - cached_time < timedelta(seconds=30):
            return cached_data
    
    # –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    data = await fetch_token_data(token_address)
    cache[cache_key] = (data, datetime.now())
    
    return data
```

### –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è API calls
- –û–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —á–∞—Å—Ç–∏ UI
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `edit_message_text` –≤–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å RPC –∑–∞–ø—Ä–æ—Å—ã

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
dex_bot/
‚îú‚îÄ‚îÄ bot.py                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ message.py        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∞–¥—Ä–µ—Å–∞ —Ç–æ–∫–µ–Ω–æ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ callbacks.py      # –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∫–Ω–æ–ø–æ–∫
‚îÇ   ‚îî‚îÄ‚îÄ commands.py       # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (/start, /help)
‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ panel.py          # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –ø–∞–Ω–µ–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ keyboards.py      # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä
‚îú‚îÄ‚îÄ blockchain/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ solana.py         # –†–∞–±–æ—Ç–∞ —Å Solana (–≤–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–æ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ jupiter.py        # Jupiter Aggregator API
‚îÇ   ‚îî‚îÄ‚îÄ tokens.py         # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py         # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (User, Order, Position)
‚îÇ   ‚îî‚îÄ‚îÄ repository.py     # CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ state_manager.py  # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ order_monitor.py  # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ price_tracker.py  # –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ü–µ–Ω
‚îÇ   ‚îî‚îÄ‚îÄ auto_refresh.py   # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–µ–π
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ validation.py     # –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ formatting.py     # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª, –¥–∞—Ç
‚îÇ   ‚îî‚îÄ‚îÄ cache.py          # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ config.py             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (API keys, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
‚îî‚îÄ‚îÄ requirements.txt      # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
```

---

## –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
```
4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R
```

**–ë–æ—Ç (—Å–Ω–∞—á–∞–ª–∞):**
```
‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–∞...
```

**–ë–æ—Ç (—á–µ—Ä–µ–∑ 1-2 —Å–µ–∫—É–Ω–¥—ã):**
```
ü™ô Raydium (RAY)
üìù 4k3D...kX6R
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä Market Cap: $245M
üíß Liquidity: $12.5M
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üíº Balance: 2.45 SOL ($482)
üìå Active Order: No
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ Quick Buy
Selected: $50 USD
Slippage: 1%

[‚úÖ Buy] [Sell] [Limit] [Track]
[$10] [$50] [$100]
[Slippage: 1%] [Gas: Auto]
[üü¢ Execute Trade]
[üîÑ Refresh] [‚ùå Close]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ Sell

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç:** `[Sell]`

**–ë–æ—Ç (–º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ):**
```
ü™ô Raydium (RAY)
üìù 4k3D...kX6R
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä Market Cap: $245M
üíß Liquidity: $12.5M
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üíº Balance: 2.45 SOL ($482)
üìå Active Order: No
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∏ Quick Sell
Amount: 100% (250 RAY)
Slippage: 1%

[Buy] [‚úÖ Sell] [Limit] [Track]
[25%] [50%] [100%]
[Slippage: 1%] [Gas: Auto]
[üî¥ Execute Sell]
[üîÑ Refresh] [‚ùå Close]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
1. –ù–∞–∂–∏–º–∞–µ—Ç `[Buy]`
2. –ù–∞–∂–∏–º–∞–µ—Ç `[$50]`
3. –ù–∞–∂–∏–º–∞–µ—Ç `[üü¢ Execute Trade]`

**–ë–æ—Ç:**
```
‚è≥ Processing trade...
```

**–ë–æ—Ç (—á–µ—Ä–µ–∑ 3-5 —Å–µ–∫—É–Ω–¥):**
```
‚úÖ Trade completed! TX: a4b8c2d1...
```

**–ë–æ—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–∞–Ω–µ–ª—å —Å –Ω–æ–≤—ã–º–∏ –±–∞–ª–∞–Ω—Å–∞–º–∏:**
```
ü™ô Raydium (RAY)
üìù 4k3D...kX6R
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä Market Cap: $245M
üíß Liquidity: $12.5M
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üíº Balance: 1.95 SOL ($384)
üìå Active Order: No
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ Quick Buy
Selected: $50 USD
Slippage: 1%

[‚úÖ Buy] [Sell] [Limit] [Track]
[$10] [$50] [$100]
[Slippage: 1%] [Gas: Auto]
[üü¢ Execute Trade]
[üîÑ Refresh] [‚ùå Close]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û—Ç–∫—Ä—ã—Ç–∏–µ –≤—Ç–æ—Ä–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å –¥—Ä—É–≥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤—Ç–æ—Ä–∞—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è –ø–∞–Ω–µ–ª—å.

---

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª Take Profit –∏ Stop Loss

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

–î–ª—è **–∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –æ—Ä–¥–µ—Ä–∞** (Market Buy/Sell, Limit) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:
- **Take Profit (TP)** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–¥–∞–∂–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–µ–≤–æ–π –ø—Ä–∏–±—ã–ª–∏
- **Stop Loss (SL)** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–¥–∞–∂–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —É—Ä–æ–≤–Ω—è —É–±—ã—Ç–∫–∞

**–í–∞–∂–Ω–æ:** TP/SL —Ä–∞–±–æ—Ç–∞—é—Ç –¥–ª—è –ø–æ–∑–∏—Ü–∏–π, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –±–æ—Ç–∞. –ë–æ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ—Ä–¥–µ—Ä–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–µ–≤—ã—Ö —É—Ä–æ–≤–Ω–µ–π.

---

### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è

```python
user_state = {
    "user_id": int,
    "message_id": int,
    "token_address": str,
    "mode": str,
    "token_data": {...},
    "user_data": {...},
    "action_data": {
        "selected_amount": float,
        "slippage": float,
        "limit_price": float,
        "position": dict,
        # –ù–û–í–û–ï: TP/SL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        "tp_enabled": bool,
        "tp_price": float,  # –¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è Take Profit
        "tp_percent": float,  # –ò–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, +20%)
        "sl_enabled": bool,
        "sl_price": float,  # –¶–µ–Ω–∞ –¥–ª—è Stop Loss
        "sl_percent": float,  # –ò–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç —É–±—ã—Ç–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, -10%)
    }
}
```

### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ Position –≤ –ë–î

```python
class Position:
    id: int
    user_id: int
    token_address: str
    entry_price: float
    size: float  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤
    entry_value_usd: float  # –°—Ç–æ–∏–º–æ—Å—Ç—å –≤—Ö–æ–¥–∞ –≤ USD
    created_at: datetime
    
    # TP/SL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    tp_enabled: bool
    tp_price: float
    sl_enabled: bool
    sl_price: float
    
    # –°—Ç–∞—Ç—É—Å
    status: str  # "active", "closed_tp", "closed_sl", "closed_manual"
    closed_at: datetime | None
    exit_price: float | None
    pnl_usd: float | None
```

---

### UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è TP/SL

#### 1. –ë–ª–æ–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ TP/SL (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Ä–µ–∂–∏–º–∞—Ö)

–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `Action Area` –∫–∞–∂–¥–æ–≥–æ —Ä–µ–∂–∏–º–∞:

```
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéØ Risk Management
Take Profit: {Enabled/Disabled} {price or %}
Stop Loss: {Enabled/Disabled} {price or %}
```

#### 2. –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è TP/SL

–î–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É **–ø–æ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π**:

```
[üéØ Set TP] [üõ°Ô∏è Set SL]
```

–ö–æ–≥–¥–∞ TP –∏–ª–∏ SL –≤–∫–ª—é—á–µ–Ω—ã:

```
[‚úÖ TP: $2.50] [‚úÖ SL: $1.80]
```

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É ‚Äî –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.

---

### –†–µ–∂–∏–º Buy —Å TP/SL

**–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–∞–Ω–µ–ª–∏:**

```
ü™ô Raydium (RAY)
üìù 4k3D...kX6R
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä Market Cap: $245M
üíß Liquidity: $12.5M
Current Price: $2.15
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üíº Balance: 2.45 SOL ($482)
üìå Active Order: No
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ Quick Buy
Selected: $50 USD
Slippage: 1%
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéØ Risk Management
Take Profit: ‚úÖ $2.50 (+16.3%)
Stop Loss: ‚úÖ $1.90 (-11.6%)
```

**Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞:**

```
[‚úÖ Buy] [Sell] [Limit] [Track]
[$10] [$50] [$100]
[Slippage: 1%] [Gas: Auto]
[‚úÖ TP: $2.50] [‚úÖ SL: $1.90]
[üü¢ Execute Trade]
[üîÑ Refresh] [‚ùå Close]
```

---

### –†–µ–∂–∏–º Sell —Å TP/SL

–î–ª—è —Ä–µ–∂–∏–º–∞ **Sell** TP/SL —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–æ–±–æ—Ä–æ—Ç:
- **Take Profit** ‚Äî –ø–æ–∫—É–ø–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ –ø–æ –±–æ–ª–µ–µ –Ω–∏–∑–∫–æ–π —Ü–µ–Ω–µ (–¥–ª—è —à–æ—Ä—Ç-–ø–æ–∑–∏—Ü–∏–π)
- **Stop Loss** ‚Äî –ø–æ–∫—É–ø–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ –ø–æ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–π —Ü–µ–Ω–µ –ø—Ä–∏ —Ä–æ—Å—Ç–µ

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í DEX –Ω–∞ Solana –Ω–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã—Ö —à–æ—Ä—Ç–æ–≤, –ø–æ—ç—Ç–æ–º—É –¥–ª—è Sell —Ä–µ–∂–∏–º–∞ TP/SL –æ–±—ã—á–Ω–æ **–ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è**. –ù–æ –µ—Å–ª–∏ –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —à–æ—Ä—Ç—ã —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã, –ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í —Ä–µ–∂–∏–º–µ Sell –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å TP/SL —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å **—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è long-–ø–æ–∑–∏—Ü–∏—è**.

---

### –†–µ–∂–∏–º Limit —Å TP/SL

**–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–∞–Ω–µ–ª–∏:**

```
ü™ô Raydium (RAY)
üìù 4k3D...kX6R
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä Market Cap: $245M
üíß Liquidity: $12.5M
Current Price: $2.15
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üíº Balance: 2.45 SOL ($482)
üìå Active Order: No
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚è≥ Limit Order
Target Price: $2.00
Amount: $50
Status: Not placed
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéØ Risk Management (after execution)
Take Profit: ‚úÖ $2.40 (+20%)
Stop Loss: ‚úÖ $1.80 (-10%)
```

**Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞:**

```
[Buy] [Sell] [‚úÖ Limit] [Track]
[Set Price: $2.00] [Set Amount: $50]
[‚úÖ TP: $2.40] [‚úÖ SL: $1.80]
[üìç Place Order]
[üîÑ Refresh] [‚ùå Close]
```

**–í–∞–∂–Ω–æ:** TP/SL –¥–ª—è –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è **–ø–æ—Å–ª–µ –µ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è**.

---

### –†–µ–∂–∏–º Track —Å TP/SL

**–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–∞–Ω–µ–ª–∏:**

```
ü™ô Raydium (RAY)
üìù 4k3D...kX6R
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä Market Cap: $245M
üíß Liquidity: $12.5M
Current Price: $2.28
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üíº Balance: 1.95 SOL ($384)
üìå Active Order: No
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìà Position Tracking
Entry: $2.15
Current: $2.28
Size: 23.26 RAY
Value: $53.03
PNL: +$3.03 (+6.05%)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéØ Active Risk Management
Take Profit: ‚úÖ $2.50 (9.6% to target)
Stop Loss: ‚úÖ $1.90 (16.7% below)
```

**Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞:**

```
[Buy] [Sell] [Limit] [‚úÖ Track]
[Edit TP: $2.50] [Edit SL: $1.90]
[üî¥ Close Position] [üìä Chart]
[üîÑ Refresh] [‚ùå Close Panel]
```

---

### –õ–æ–≥–∏–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ TP/SL

#### Callback patterns –¥–ª—è TP/SL

```
tp_sl:set_tp          # –û—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Take Profit
tp_sl:set_sl          # –û—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Stop Loss
tp_sl:disable_tp      # –û—Ç–∫–ª—é—á–∏—Ç—å Take Profit
tp_sl:disable_sl      # –û—Ç–∫–ª—é—á–∏—Ç—å Stop Loss
tp_sl:mode:price      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ —Ü–µ–Ω–µ
tp_sl:mode:percent    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É
```

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Take Profit

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç:** `[üéØ Set TP]`

**–ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:**

```
üéØ Take Profit Setup

–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

[üíµ By Price] [üìä By Percent]
[‚ùå Cancel]
```

**–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "By Price":**

```python
async def handle_set_tp_price(update, context):
    query = update.callback_query
    user_state = get_user_state(query.from_user.id)
    
    user_state["waiting_for"] = "tp_price"
    save_user_state(user_state)
    
    await query.answer()
    await query.message.reply_text(
        "üíµ –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–µ–≤—É—é —Ü–µ–Ω—É –¥–ª—è Take Profit –≤ USD:\n"
        f"–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: ${user_state['token_data']['current_price']}"
    )
```

**–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "By Percent":**

```python
async def handle_set_tp_percent(update, context):
    query = update.callback_query
    user_state = get_user_state(query.from_user.id)
    
    user_state["waiting_for"] = "tp_percent"
    save_user_state(user_state)
    
    await query.answer()
    await query.message.reply_text(
        "üìä –í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª–∏ –¥–ª—è Take Profit (–Ω–∞–ø—Ä–∏–º–µ—Ä: 20 –¥–ª—è +20%):\n"
        f"–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: ${user_state['token_data']['current_price']}"
    )
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞:**

```python
async def handle_tp_sl_input(update, context):
    user_state = get_user_state(update.effective_user.id)
    waiting_for = user_state.get("waiting_for")
    
    if waiting_for == "tp_price":
        try:
            tp_price = float(update.message.text)
            current_price = user_state["token_data"]["current_price"]
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è: TP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã –¥–ª—è long
            if tp_price <= current_price:
                await update.message.reply_text(
                    "‚ö†Ô∏è Take Profit –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã"
                )
                return
            
            # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç
            tp_percent = ((tp_price - current_price) / current_price) * 100
            
            user_state["action_data"]["tp_enabled"] = True
            user_state["action_data"]["tp_price"] = tp_price
            user_state["action_data"]["tp_percent"] = tp_percent
            user_state["waiting_for"] = None
            
            save_user_state(user_state)
            
            # –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
            await context.bot.edit_message_text(
                chat_id=user_state["user_id"],
                message_id=user_state["message_id"],
                text=generate_panel_text(user_state),
                reply_markup=generate_keyboard(user_state)
            )
            
            await update.message.reply_text(
                f"‚úÖ Take Profit —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${tp_price} (+{tp_percent:.1f}%)"
            )
            
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞")
    
    elif waiting_for == "tp_percent":
        try:
            tp_percent = float(update.message.text)
            current_price = user_state["token_data"]["current_price"]
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è: TP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º
            if tp_percent <= 0:
                await update.message.reply_text(
                    "‚ö†Ô∏è –ü—Ä–æ—Ü–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º"
                )
                return
            
            # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É
            tp_price = current_price * (1 + tp_percent / 100)
            
            user_state["action_data"]["tp_enabled"] = True
            user_state["action_data"]["tp_price"] = tp_price
            user_state["action_data"]["tp_percent"] = tp_percent
            user_state["waiting_for"] = None
            
            save_user_state(user_state)
            
            # –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
            await context.bot.edit_message_text(
                chat_id=user_state["user_id"],
                message_id=user_state["message_id"],
                text=generate_panel_text(user_state),
                reply_markup=generate_keyboard(user_state)
            )
            
            await update.message.reply_text(
                f"‚úÖ Take Profit —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${tp_price:.4f} (+{tp_percent}%)"
            )
            
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç")
```

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Stop Loss

–õ–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ Take Profit, –Ω–æ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π:
- SL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–Ω–∏–∂–µ** —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã –¥–ª—è long-–ø–æ–∑–∏—Ü–∏–π
- –ü—Ä–æ—Ü–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∏–ª–∏ –≤–≤–æ–¥–∏—Ç—å—Å—è –∫–∞–∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ —Å —É—á–µ—Ç–æ–º —É–±—ã—Ç–∫–∞

```python
async def handle_sl_input(update, context):
    user_state = get_user_state(update.effective_user.id)
    waiting_for = user_state.get("waiting_for")
    
    if waiting_for == "sl_price":
        try:
            sl_price = float(update.message.text)
            current_price = user_state["token_data"]["current_price"]
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è: SL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã –¥–ª—è long
            if sl_price >= current_price:
                await update.message.reply_text(
                    "‚ö†Ô∏è Stop Loss –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã"
                )
                return
            
            # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç (–±—É–¥–µ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)
            sl_percent = ((sl_price - current_price) / current_price) * 100
            
            user_state["action_data"]["sl_enabled"] = True
            user_state["action_data"]["sl_price"] = sl_price
            user_state["action_data"]["sl_percent"] = sl_percent
            user_state["waiting_for"] = None
            
            save_user_state(user_state)
            
            await context.bot.edit_message_text(
                chat_id=user_state["user_id"],
                message_id=user_state["message_id"],
                text=generate_panel_text(user_state),
                reply_markup=generate_keyboard(user_state)
            )
            
            await update.message.reply_text(
                f"‚úÖ Stop Loss —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${sl_price} ({sl_percent:.1f}%)"
            )
            
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞")
    
    elif waiting_for == "sl_percent":
        try:
            sl_percent_input = float(update.message.text)
            current_price = user_state["token_data"]["current_price"]
            
            # –ü—Ä–∏–Ω–∏–º–∞–µ–º –∫–∞–∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ (10 = -10%)
            if sl_percent_input <= 0:
                await update.message.reply_text(
                    "‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 10 –¥–ª—è -10%)"
                )
                return
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç
            sl_percent = -sl_percent_input
            
            # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É
            sl_price = current_price * (1 + sl_percent / 100)
            
            user_state["action_data"]["sl_enabled"] = True
            user_state["action_data"]["sl_price"] = sl_price
            user_state["action_data"]["sl_percent"] = sl_percent
            user_state["waiting_for"] = None
            
            save_user_state(user_state)
            
            await context.bot.edit_message_text(
                chat_id=user_state["user_id"],
                message_id=user_state["message_id"],
                text=generate_panel_text(user_state),
                reply_markup=generate_keyboard(user_state)
            )
            
            await update.message.reply_text(
                f"‚úÖ Stop Loss —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${sl_price:.4f} ({sl_percent}%)"
            )
            
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç")
```

---

### –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫ —Å TP/SL

#### Market Buy —Å TP/SL

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç `[üü¢ Execute Trade]`:

```python
async def handle_execute_buy_with_tp_sl(update, context):
    query = update.callback_query
    user_state = get_user_state(query.from_user.id)
    
    await query.answer("‚è≥ Executing trade...")
    
    try:
        # 1. –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∫—É–ø–∫—É
        tx_result = await execute_swap(
            token_address=user_state["token_address"],
            amount_usd=user_state["action_data"]["selected_amount"],
            slippage=user_state["action_data"]["slippage"],
            action="buy"
        )
        
        # 2. –°–æ–∑–¥–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –≤ –ë–î
        position = await create_position(
            user_id=user_state["user_id"],
            token_address=user_state["token_address"],
            entry_price=tx_result["execution_price"],
            size=tx_result["tokens_received"],
            entry_value_usd=user_state["action_data"]["selected_amount"],
            tp_enabled=user_state["action_data"].get("tp_enabled", False),
            tp_price=user_state["action_data"].get("tp_price"),
            sl_enabled=user_state["action_data"].get("sl_enabled", False),
            sl_price=user_state["action_data"].get("sl_price")
        )
        
        # 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TP/SL
        if position.tp_enabled or position.sl_enabled:
            await start_tp_sl_monitor(position.id)
        
        # 4. –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã
        await refresh_user_balances(user_state)
        
        # 5. –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        await query.answer(
            f"‚úÖ Buy completed!\n"
            f"Price: ${tx_result['execution_price']}\n"
            f"Amount: {tx_result['tokens_received']} tokens",
            show_alert=True
        )
        
        # 6. –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
        await query.edit_message_text(
            text=generate_panel_text(user_state),
            reply_markup=generate_keyboard(user_state)
        )
        
    except Exception as e:
        await query.answer(f"‚ùå Error: {str(e)}", show_alert=True)
```

#### Limit Order —Å TP/SL

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–º–µ—â–∞–µ—Ç –ª–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä:

```python
async def handle_place_limit_with_tp_sl(update, context):
    query = update.callback_query
    user_state = get_user_state(query.from_user.id)
    
    # –°–æ–∑–¥–∞—Ç—å –ª–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä
    limit_order = await create_limit_order(
        user_id=user_state["user_id"],
        token_address=user_state["token_address"],
        target_price=user_state["action_data"]["limit_price"],
        amount_usd=user_state["action_data"]["selected_amount"],
        tp_enabled=user_state["action_data"].get("tp_enabled", False),
        tp_price=user_state["action_data"].get("tp_price"),
        sl_enabled=user_state["action_data"].get("sl_enabled", False),
        sl_price=user_state["action_data"].get("sl_price")
    )
    
    # –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
    await start_limit_order_monitor(limit_order.id)
    
    await query.answer("‚úÖ –õ–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω —Å TP/SL")
```

–ö–æ–≥–¥–∞ –ª–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è:

```python
async def on_limit_order_executed(limit_order):
    """
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –ª–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–µ–Ω
    """
    # –°–æ–∑–¥–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é
    position = await create_position(
        user_id=limit_order.user_id,
        token_address=limit_order.token_address,
        entry_price=limit_order.execution_price,
        size=limit_order.tokens_received,
        entry_value_usd=limit_order.amount_usd,
        tp_enabled=limit_order.tp_enabled,
        tp_price=limit_order.tp_price,
        sl_enabled=limit_order.sl_enabled,
        sl_price=limit_order.sl_price
    )
    
    # –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TP/SL
    if position.tp_enabled or position.sl_enabled:
        await start_tp_sl_monitor(position.id)
    
    # –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await send_notification(
        user_id=limit_order.user_id,
        text=f"‚úÖ –õ–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–µ–Ω!\n"
             f"–¢–æ–∫–µ–Ω: {position.token_address[:8]}...\n"
             f"–¶–µ–Ω–∞: ${position.entry_price}\n"
             f"–†–∞–∑–º–µ—Ä: {position.size} tokens"
    )
```

---

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TP/SL (—Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å)

**–°–µ—Ä–≤–∏—Å `tp_sl_monitor.py`:**

```python
import asyncio
from datetime import datetime

class TPSLMonitor:
    """
    –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Take Profit –∏ Stop Loss –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
    """
    
    def __init__(self):
        self.active_monitors = {}  # position_id -> Task
    
    async def start_monitor(self, position_id: int):
        """
        –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏
        """
        if position_id in self.active_monitors:
            return  # –£–∂–µ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—Å—è
        
        task = asyncio.create_task(self._monitor_position(position_id))
        self.active_monitors[position_id] = task
    
    async def stop_monitor(self, position_id: int):
        """
        –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∑–∏—Ü–∏–∏
        """
        if position_id in self.active_monitors:
            task = self.active_monitors[position_id]
            task.cancel()
            del self.active_monitors[position_id]
    
    async def _monitor_position(self, position_id: int):
        """
        –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ–∑–∏—Ü–∏–∏
        """
        try:
            while True:
                # –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
                position = await get_position(position_id)
                
                if not position or position.status != "active":
                    break  # –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                
                # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
                current_price = await get_token_price(position.token_address)
                
                # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Take Profit
                if position.tp_enabled and current_price >= position.tp_price:
                    await self._execute_take_profit(position, current_price)
                    break
                
                # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Stop Loss
                if position.sl_enabled and current_price <= position.sl_price:
                    await self._execute_stop_loss(position, current_price)
                    break
                
                # –ü–æ–¥–æ–∂–¥–∞—Ç—å –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
                await asyncio.sleep(2)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
                
        except asyncio.CancelledError:
            pass  # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
        except Exception as e:
            logger.error(f"Error monitoring position {position_id}: {e}")
        finally:
            if position_id in self.active_monitors:
                del self.active_monitors[position_id]
    
    async def _execute_take_profit(self, position, current_price: float):
        """
        –í—ã–ø–æ–ª–Ω–∏—Ç—å Take Profit (–ø—Ä–æ–¥–∞–∂–∞)
        """
        try:
            # –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É
            tx_result = await execute_swap(
                token_address=position.token_address,
                amount_tokens=position.size,
                action="sell",
                slippage=1.0  # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            )
            
            # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å PNL
            exit_value = tx_result["usd_received"]
            pnl_usd = exit_value - position.entry_value_usd
            
            # –ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é
            await close_position(
                position_id=position.id,
                exit_price=tx_result["execution_price"],
                pnl_usd=pnl_usd,
                status="closed_tp"
            )
            
            # –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await send_notification(
                user_id=position.user_id,
                text=f"üéØ Take Profit —Å—Ä–∞–±–æ—Ç–∞–ª!\n"
                     f"–¢–æ–∫–µ–Ω: {position.token_address[:8]}...\n"
                     f"–¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞: ${tx_result['execution_price']}\n"
                     f"PNL: ${pnl_usd:+.2f} ({(pnl_usd/position.entry_value_usd)*100:+.1f}%)\n"
                     f"TX: {tx_result['signature'][:8]}..."
            )
            
        except Exception as e:
            logger.error(f"Error executing TP for position {position.id}: {e}")
            await send_notification(
                user_id=position.user_id,
                text=f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Take Profit: {str(e)}"
            )
    
    async def _execute_stop_loss(self, position, current_price: float):
        """
        –í—ã–ø–æ–ª–Ω–∏—Ç—å Stop Loss (–ø—Ä–æ–¥–∞–∂–∞)
        """
        try:
            # –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É
            tx_result = await execute_swap(
                token_address=position.token_address,
                amount_tokens=position.size,
                action="sell",
                slippage=2.0  # –ë–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–π slippage –¥–ª—è SL
            )
            
            # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å PNL
            exit_value = tx_result["usd_received"]
            pnl_usd = exit_value - position.entry_value_usd
            
            # –ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é
            await close_position(
                position_id=position.id,
                exit_price=tx_result["execution_price"],
                pnl_usd=pnl_usd,
                status="closed_sl"
            )
            
            # –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await send_notification(
                user_id=position.user_id,
                text=f"üõ°Ô∏è Stop Loss —Å—Ä–∞–±–æ—Ç–∞–ª!\n"
                     f"–¢–æ–∫–µ–Ω: {position.token_address[:8]}...\n"
                     f"–¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞: ${tx_result['execution_price']}\n"
                     f"PNL: ${pnl_usd:+.2f} ({(pnl_usd/position.entry_value_usd)*100:+.1f}%)\n"
                     f"TX: {tx_result['signature'][:8]}..."
            )
            
        except Exception as e:
            logger.error(f"Error executing SL for position {position.id}: {e}")
            await send_notification(
                user_id=position.user_id,
                text=f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Stop Loss: {str(e)}"
            )

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –º–æ–Ω–∏—Ç–æ—Ä–∞
tp_sl_monitor = TPSLMonitor()
```

---

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ –ø–∞–Ω–µ–ª–∏

```python
def generate_panel_text(user_state: dict) -> str:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ —Ç–æ—Ä–≥–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
    """
    token = user_state["token_data"]
    user = user_state["user_data"]
    action = user_state["action_data"]
    mode = user_state["mode"]
    
    # Header (–≤—Å–µ–≥–¥–∞)
    text = f"ü™ô {token['name']} ({token['ticker']})\n"
    text += f"üìù {shorten_address(user_state['token_address'])}\n"
    text += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    
    # Token Info (–≤—Å–µ–≥–¥–∞)
    text += f"üìä Market Cap: ${format_number(token['market_cap'])}\n"
    text += f"üíß Liquidity: ${format_number(token['liquidity'])}\n"
    text += f"üí∞ Current Price: ${token['current_price']:.4f}\n"
    text += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    
    # User Info (–≤—Å–µ–≥–¥–∞)
    text += f"üíº Balance: {user['sol_balance']:.2f} SOL (${user['usd_balance']:.2f})\n"
    text += f"üìå Active Order: {'Yes' if user['has_active_order'] else 'No'}\n"
    text += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    
    # Action Area (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∂–∏–º–∞)
    if mode == "buy":
        text += "üí∞ Quick Buy\n"
        text += f"Selected: ${action['selected_amount']} USD\n"
        text += f"Slippage: {action['slippage']}%\n"
    
    elif mode == "sell":
        text += "üí∏ Quick Sell\n"
        text += f"Amount: {action.get('sell_percent', 100)}% "
        if action.get('token_balance'):
            text += f"({action['token_balance']} tokens)\n"
        else:
            text += "\n"
        text += f"Slippage: {action['slippage']}%\n"
    
    elif mode == "limit":
        text += "‚è≥ Limit Order\n"
        text += f"Target Price: ${action.get('limit_price', 'Not set')}\n"
        text += f"Amount: ${action.get('selected_amount', 'Not set')}\n"
        if action.get('order_status'):
            text += f"Status: {action['order_status']}\n"
    
    elif mode == "track":
        text += "üìà Position Tracking\n"
        position = action.get('position')
        if position:
            text += f"Entry: ${position['entry_price']:.4f}\n"
            text += f"Current: ${position['current_price']:.4f}\n"
            text += f"Size: {position['size']:.2f} tokens\n"
            text += f"Value: ${position['size'] * position['current_price']:.2f}\n"
            pnl_emoji = "üü¢" if position['pnl_usd'] >= 0 else "üî¥"
            text += f"PNL: {pnl_emoji} ${position['pnl_usd']:+.2f} ({position['pnl_percent']:+.2f}%)\n"
        else:
            text += "No active position for this token\n"
    
    # TP/SL Block (–≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
    if action.get('tp_enabled') or action.get('sl_enabled'):
        text += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        text += "üéØ Risk Management\n"
        
        if action.get('tp_enabled'):
            tp_price = action['tp_price']
            tp_percent = action['tp_percent']
            
            # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ TP
            if mode == "track" and action.get('position'):
                current = action['position']['current_price']
                distance = ((tp_price - current) / current) * 100
                text += f"Take Profit: ‚úÖ ${tp_price:.4f} ({distance:+.1f}% to target)\n"
            else:
                text += f"Take Profit: ‚úÖ ${tp_price:.4f} (+{tp_percent:.1f}%)\n"
        else:
            text += "Take Profit: ‚ùå Not set\n"
        
        if action.get('sl_enabled'):
            sl_price = action['sl_price']
            sl_percent = action['sl_percent']
            
            # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ SL
            if mode == "track" and action.get('position'):
                current = action['position']['current_price']
                distance = ((current - sl_price) / current) * 100
                text += f"Stop Loss: ‚úÖ ${sl_price:.4f} ({distance:.1f}% below)\n"
            else:
                text += f"Stop Loss: ‚úÖ ${sl_price:.4f} ({sl_percent:.1f}%)\n"
        else:
            text += "Stop Loss: ‚ùå Not set\n"
    
    return text


def generate_keyboard(user_state: dict) -> InlineKeyboardMarkup:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    """
    mode = user_state["mode"]
    action = user_state["action_data"]
    
    keyboard = []
    
    # –°—Ç—Ä–æ–∫–∞ 1: –†–µ–∂–∏–º—ã
    mode_row = []
    modes = {
        "buy": "‚úÖ Buy" if mode == "buy" else "Buy",
        "sell": "‚úÖ Sell" if mode == "sell" else "Sell",
        "limit": "‚úÖ Limit" if mode == "limit" else "Limit",
        "track": "‚úÖ Track" if mode == "track" else "Track"
    }
    
    for mode_key, mode_label in modes.items():
        mode_row.append(
            InlineKeyboardButton(mode_label, callback_data=f"mode:{mode_key}")
        )
    keyboard.append(mode_row)
    
    # –°—Ç—Ä–æ–∫–∏ 2-N: –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (–∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ä–µ–∂–∏–º–∞)
    if mode == "buy":
        # –°—Ç—Ä–æ–∫–∞ –≤—ã–±–æ—Ä–∞ —Å—É–º–º—ã
        amount_row = []
        for amount in [10, 50, 100]:
            label = f"${amount}"
            if action.get('selected_amount') == amount:
                label = f"‚úÖ {label}"
            amount_row.append(
                InlineKeyboardButton(label, callback_data=f"amount:{amount}")
            )
        keyboard.append(amount_row)
        
        # –°—Ç—Ä–æ–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        settings_row = [
            InlineKeyboardButton(
                f"Slippage: {action.get('slippage', 1)}%",
                callback_data="settings:slippage"
            ),
            InlineKeyboardButton("Gas: Auto", callback_data="settings:gas")
        ]
        keyboard.append(settings_row)
        
        # –°—Ç—Ä–æ–∫–∞ TP/SL
        tp_sl_row = []
        if action.get('tp_enabled'):
            tp_sl_row.append(
                InlineKeyboardButton(
                    f"‚úÖ TP: ${action['tp_price']:.2f}",
                    callback_data="tp_sl:edit_tp"
                )
            )
        else:
            tp_sl_row.append(
                InlineKeyboardButton("üéØ Set TP", callback_data="tp_sl:set_tp")
            )
        
        if action.get('sl_enabled'):
            tp_sl_row.append(
                InlineKeyboardButton(
                    f"‚úÖ SL: ${action['sl_price']:.2f}",
                    callback_data="tp_sl:edit_sl"
                )
            )
        else:
            tp_sl_row.append(
                InlineKeyboardButton("üõ°Ô∏è Set SL", callback_data="tp_sl:set_sl")
            )
        keyboard.append(tp_sl_row)
        
        # –ö–Ω–æ–ø–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        keyboard.append([
            InlineKeyboardButton("üü¢ Execute Buy", callback_data="execute:buy")
        ])
    
    elif mode == "sell":
        # –°—Ç—Ä–æ–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–∞
        percent_row = []
        for percent in [25, 50, 100]:
            label = f"{percent}%"
            if action.get('sell_percent') == percent:
                label = f"‚úÖ {label}"
            percent_row.append(
                InlineKeyboardButton(label, callback_data=f"sell_percent:{percent}")
            )
        keyboard.append(percent_row)
        
        # –°—Ç—Ä–æ–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        settings_row = [
            InlineKeyboardButton(
                f"Slippage: {action.get('slippage', 1)}%",
                callback_data="settings:slippage"
            ),
            InlineKeyboardButton("Gas: Auto", callback_data="settings:gas")
        ]
        keyboard.append(settings_row)
        
        # –ö–Ω–æ–ø–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        keyboard.append([
            InlineKeyboardButton("üî¥ Execute Sell", callback_data="execute:sell")
        ])
    
    elif mode == "limit":
        # –ö–Ω–æ–ø–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        keyboard.append([
            InlineKeyboardButton(
                f"Set Price: ${action.get('limit_price', '?')}",
                callback_data="limit:set_price"
            ),
            InlineKeyboardButton(
                f"Set Amount: ${action.get('selected_amount', '?')}",
                callback_data="limit:set_amount"
            )
        ])
        
        # –°—Ç—Ä–æ–∫–∞ TP/SL
        tp_sl_row = []
        if action.get('tp_enabled'):
            tp_sl_row.append(
                InlineKeyboardButton(
                    f"‚úÖ TP: ${action['tp_price']:.2f}",
                    callback_data="tp_sl:edit_tp"
                )
            )
        else:
            tp_sl_row.append(
                InlineKeyboardButton("üéØ Set TP", callback_data="tp_sl:set_tp")
            )
        
        if action.get('sl_enabled'):
            tp_sl_row.append(
                InlineKeyboardButton(
                    f"‚úÖ SL: ${action['sl_price']:.2f}",
                    callback_data="tp_sl:edit_sl"
                )
            )
        else:
            tp_sl_row.append(
                InlineKeyboardButton("üõ°Ô∏è Set SL", callback_data="tp_sl:set_sl")
            )
        keyboard.append(tp_sl_row)
        
        # –ö–Ω–æ–ø–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è/–æ—Ç–º–µ–Ω—ã –æ—Ä–¥–µ—Ä–∞
        if action.get('order_status') == 'active':
            keyboard.append([
                InlineKeyboardButton("‚ùå Cancel Order", callback_data="limit:cancel")
            ])
        else:
            keyboard.append([
                InlineKeyboardButton("üìç Place Order", callback_data="limit:place")
            ])
    
    elif mode == "track":
        # –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è TP/SL (–µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –µ—Å—Ç—å)
        if action.get('position'):
            tp_sl_row = []
            if action.get('tp_enabled'):
                tp_sl_row.append(
                    InlineKeyboardButton(
                        f"Edit TP: ${action['tp_price']:.2f}",
                        callback_data="tp_sl:edit_tp"
                    )
                )
            else:
                tp_sl_row.append(
                    InlineKeyboardButton("üéØ Set TP", callback_data="tp_sl:set_tp")
                )
            
            if action.get('sl_enabled'):
                tp_sl_row.append(
                    InlineKeyboardButton(
                        f"Edit SL: ${action['sl_price']:.2f}",
                        callback_data="tp_sl:edit_sl"
                    )
                )
            else:
                tp_sl_row.append(
                    InlineKeyboardButton("üõ°Ô∏è Set SL", callback_data="tp_sl:set_sl")
                )
            keyboard.append(tp_sl_row)
            
            # –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏
            keyboard.append([
                InlineKeyboardButton("üî¥ Close Position", callback_data="track:close_position")
            ])
        
        # –ö–Ω–æ–ø–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        keyboard.append([
            InlineKeyboardButton("üìä Chart", callback_data="track:chart")
        ])
    
    # –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    keyboard.append([
        InlineKeyboardButton("üîÑ Refresh", callback_data="refresh:data"),
        InlineKeyboardButton("‚ùå Close", callback_data="panel:close")
    ])
    
    return InlineKeyboardMarkup(keyboard)


def format_number(num: float) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª (1.2M, 450K)
    """
    if num >= 1_000_000_000:
        return f"{num / 1_000_000_000:.1f}B"
    elif num >= 1_000_000:
        return f"{num / 1_000_000:.1f}M"
    elif num >= 1_000:
        return f"{num / 1_000:.1f}K"
    else:
        return f"{num:.2f}"


def shorten_address(address: str) -> str:
    """
    –°–æ–∫—Ä–∞—Ç–∏—Ç—å –∞–¥—Ä–µ—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    """
    return f"{address[:4]}...{address[-4:]}"
```

---

### –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TP/SL –≤ —Ä–µ–∂–∏–º–µ Track

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç `[Edit TP]` –∏–ª–∏ `[Edit SL]` –≤ —Ä–µ–∂–∏–º–µ Track:

```python
async def handle_edit_tp_in_track(update, context):
    """
    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Take Profit –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    """
    query = update.callback_query
    user_state = get_user_state(query.from_user.id)
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
    position = user_state["action_data"].get("position")
    if not position:
        await query.answer("‚ö†Ô∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏", show_alert=True)
        return
    
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–Ω—é –≤—ã–±–æ—Ä–∞
    keyboard = [
        [
            InlineKeyboardButton("üíµ By Price", callback_data="tp_sl:mode:price:tp"),
            InlineKeyboardButton("üìä By Percent", callback_data="tp_sl:mode:percent:tp")
        ],
        [InlineKeyboardButton("‚ùå Disable TP", callback_data="tp_sl:disable_tp")],
        [InlineKeyboardButton("¬´ Back", callback_data="tp_sl:cancel")]
    ]
    
    await query.message.reply_text(
        "üéØ Edit Take Profit\n\n"
        f"Current TP: ${user_state['action_data']['tp_price']:.4f}\n"
        f"Current Price: ${position['current_price']:.4f}\n\n"
        "Choose how to set new TP:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    await query.answer()


async def handle_disable_tp(update, context):
    """
    –û—Ç–∫–ª—é—á–∏—Ç—å Take Profit
    """
    query = update.callback_query
    user_state = get_user_state(query.from_user.id)
    
    # –û—Ç–∫–ª—é—á–∏—Ç—å TP –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    user_state["action_data"]["tp_enabled"] = False
    user_state["action_data"]["tp_price"] = None
    user_state["action_data"]["tp_percent"] = None
    
    # –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –≤ –ë–î
    position_id = user_state["action_data"]["position"].get("id")
    if position_id:
        await update_position_tp_sl(
            position_id=position_id,
            tp_enabled=False,
            tp_price=None
        )
    
    save_user_state(user_state)
    
    # –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
    await context.bot.edit_message_text(
        chat_id=user_state["user_id"],
        message_id=user_state["message_id"],
        text=generate_panel_text(user_state),
        reply_markup=generate_keyboard(user_state)
    )
    
    await query.message.reply_text("‚úÖ Take Profit –æ—Ç–∫–ª—é—á–µ–Ω")
    await query.answer()


async def handle_update_position_tp_sl(position_id: int, tp_enabled: bool = None, 
                                       tp_price: float = None, sl_enabled: bool = None,
                                       sl_price: float = None):
    """
    –û–±–Ω–æ–≤–∏—Ç—å TP/SL –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ –≤ –ë–î
    """
    position = await get_position(position_id)
    
    if tp_enabled is not None:
        position.tp_enabled = tp_enabled
    if tp_price is not None:
        position.tp_price = tp_price
    if sl_enabled is not None:
        position.sl_enabled = sl_enabled
    if sl_price is not None:
        position.sl_price = sl_price
    
    await save_position(position)
    
    # –ï—Å–ª–∏ TP/SL –æ—Ç–∫–ª—é—á–µ–Ω—ã –æ–±–∞, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    if not position.tp_enabled and not position.sl_enabled:
        await tp_sl_monitor.stop_monitor(position_id)
    # –ï—Å–ª–∏ –≤–∫–ª—é—á–∏–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω, –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    elif position.tp_enabled or position.sl_enabled:
        await tp_sl_monitor.start_monitor(position_id)
```

---

### –†—É—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç `[üî¥ Close Position]`:

```python
async def handle_close_position(update, context):
    """
    –†—É—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏
    """
    query = update.callback_query
    user_state = get_user_state(query.from_user.id)
    
    position = user_state["action_data"].get("position")
    if not position:
        await query.answer("‚ö†Ô∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏", show_alert=True)
        return
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    await query.answer("‚è≥ Closing position...")
    
    try:
        # –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É
        tx_result = await execute_swap(
            token_address=user_state["token_address"],
            amount_tokens=position["size"],
            action="sell",
            slippage=1.0
        )
        
        # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å PNL
        exit_value = tx_result["usd_received"]
        pnl_usd = exit_value - position["entry_value_usd"]
        
        # –ó–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é –≤ –ë–î
        await close_position(
            position_id=position["id"],
            exit_price=tx_result["execution_price"],
            pnl_usd=pnl_usd,
            status="closed_manual"
        )
        
        # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TP/SL
        await tp_sl_monitor.stop_monitor(position["id"])
        
        # –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        user_state["action_data"]["position"] = None
        await refresh_user_balances(user_state)
        
        # –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        await query.answer(
            f"‚úÖ Position closed\n"
            f"PNL: ${pnl_usd:+.2f} ({(pnl_usd/position['entry_value_usd'])*100:+.1f}%)",
            show_alert=True
        )
        
        # –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
        await query.edit_message_text(
            text=generate_panel_text(user_state),
            reply_markup=generate_keyboard(user_state)
        )
        
    except Exception as e:
        await query.answer(f"‚ùå Error: {str(e)}", show_alert=True)
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ TP/SL

### Trailing Stop Loss

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:** Stop Loss –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—ã—à–∞–µ—Ç—Å—è –≤—Å–ª–µ–¥ –∑–∞ —Ü–µ–Ω–æ–π, —Ñ–∏–∫—Å–∏—Ä—É—è –ø—Ä–∏–±—ã–ª—å.

**–ü—Ä–∏–º–µ—Ä:** 
- –í—Ö–æ–¥–Ω–∞—è —Ü–µ–Ω–∞: $2.00
- Trailing SL: -10% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞
- –¶–µ–Ω–∞ —Ä–∞—Å—Ç–µ—Ç –¥–æ $3.00 ‚Üí SL –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –¥–æ $2.70
- –¶–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç –¥–æ $2.70 ‚Üí —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç SL

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
class TrailingStopLoss:
    """
    Trailing Stop Loss –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏
    """
    
    def __init__(self, position_id: int, trailing_percent: float):
        self.position_id = position_id
        self.trailing_percent = trailing_percent
        self.highest_price = None
    
    async def update(self, current_price: float):
        """
        –û–±–Ω–æ–≤–∏—Ç—å Trailing SL
        """
        # –û–±–Ω–æ–≤–∏—Ç—å –º–∞–∫—Å–∏–º—É–º
        if self.highest_price is None or current_price > self.highest_price:
            self.highest_price = current_price
            
            # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–æ–≤—ã–π SL
            new_sl_price = self.highest_price * (1 - self.trailing_percent / 100)
            
            # –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
            await update_position_tp_sl(
                position_id=self.position_id,
                sl_price=new_sl_price
            )
            
            logger.info(
                f"Trailing SL updated: highest={self.highest_price:.4f}, "
                f"new_sl={new_sl_price:.4f}"
            )
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ
        position = await get_position(self.position_id)
        if current_price <= position.sl_price:
            return True  # Trailing SL —Å—Ä–∞–±–æ—Ç–∞–ª
        
        return False
```

**–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ UI:**

```python
# –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö SL –¥–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏—é Trailing
keyboard = [
    [InlineKeyboardButton("üíµ Fixed Price", callback_data="sl:mode:fixed")],
    [InlineKeyboardButton("üìä Fixed Percent", callback_data="sl:mode:percent")],
    [InlineKeyboardButton("üîÑ Trailing %", callback_data="sl:mode:trailing")],
    [InlineKeyboardButton("‚ùå Cancel", callback_data="tp_sl:cancel")]
]
```

---

### Partial Take Profit (–ß–∞—Å—Ç–∏—á–Ω—ã–π TP)

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:** –ü—Ä–æ–¥–∞–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é —á–∞—Å—Ç—è–º–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –ø—Ä–∏–±—ã–ª–∏.

**–ü—Ä–∏–º–µ—Ä:**
- TP1: +10% ‚Üí –ø—Ä–æ–¥–∞—Ç—å 30% –ø–æ–∑–∏—Ü–∏–∏
- TP2: +20% ‚Üí –ø—Ä–æ–¥–∞—Ç—å –µ—â–µ 30%
- TP3: +50% ‚Üí –ø—Ä–æ–¥–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ 40%

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:**

```python
position = {
    ...
    "partial_tp_enabled": True,
    "partial_tp_levels": [
        {"percent": 10, "sell_amount": 30, "status": "pending"},
        {"percent": 20, "sell_amount": 30, "status": "pending"},
        {"percent": 50, "sell_amount": 40, "status": "pending"}
    ]
}
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**

```python
async def check_partial_tp(position, current_price: float):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–µ TP
    """
    for level in position["partial_tp_levels"]:
        if level["status"] == "pending":
            # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–ª–µ–≤—É—é —Ü–µ–Ω—É
            target_price = position["entry_price"] * (1 + level["percent"] / 100)
            
            if current_price >= target_price:
                # –ü—Ä–æ–¥–∞—Ç—å —á–∞—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏
                sell_amount = position["size"] * (level["sell_amount"] / 100)
                
                await execute_swap(
                    token_address=position["token_address"],
                    amount_tokens=sell_amount,
                    action="sell"
                )
                
                # –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                level["status"] = "executed"
                await save_position(position)
                
                # –£–≤–µ–¥–æ–º–∏—Ç—å
                await send_notification(
                    user_id=position["user_id"],
                    text=f"üéØ Partial TP {level['percent']}% executed!\n"
                         f"Sold {level['sell_amount']}% of position"
                )
```

---

## –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
dex_bot/
‚îú‚îÄ‚îÄ bot.py
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ message.py
‚îÇ   ‚îú‚îÄ‚îÄ callbacks.py
‚îÇ   ‚îú‚îÄ‚îÄ commands.py
‚îÇ   ‚îî‚îÄ‚îÄ tp_sl_handlers.py      # NEW: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ TP/SL
‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ panel.py
‚îÇ   ‚îî‚îÄ‚îÄ keyboards.py
‚îú‚îÄ‚îÄ blockchain/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ solana.py
‚îÇ   ‚îú‚îÄ‚îÄ jupiter.py
‚îÇ   ‚îî‚îÄ‚îÄ tokens.py
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îî‚îÄ‚îÄ repository.py
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ state_manager.py
‚îÇ   ‚îú‚îÄ‚îÄ order_monitor.py
‚îÇ   ‚îú‚îÄ‚îÄ price_tracker.py
‚îÇ   ‚îú‚îÄ‚îÄ auto_refresh.py
‚îÇ   ‚îú‚îÄ‚îÄ tp_sl_monitor.py       # NEW: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TP/SL
‚îÇ   ‚îî‚îÄ‚îÄ trailing_sl.py         # NEW: Trailing Stop Loss
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ validation.py
‚îÇ   ‚îú‚îÄ‚îÄ formatting.py
‚îÇ   ‚îî‚îÄ‚îÄ cache.py
‚îú‚îÄ‚îÄ config.py
‚îî‚îÄ‚îÄ requirements.txt
```

---

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

‚úÖ –ü–∞–Ω–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞–¥—Ä–µ—Å–∞ —Ç–æ–∫–µ–Ω–∞  
‚úÖ –í—Å–µ 4 —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç–æ–∫–µ–Ω–∞  
‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ Action Area  
‚úÖ Header, Token Info, User Info –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã  
‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ Buy/Sell  
‚úÖ –õ–∏–º–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è –∏ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è  
‚úÖ –†–µ–∂–∏–º Track –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç PNL –ø–æ–∑–∏—Ü–∏–∏  
‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫)  

**NEW: TP/SL —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**  
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å TP –∏ SL –¥–ª—è Market Buy –æ—Ä–¥–µ—Ä–æ–≤  
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å TP –∏ SL –¥–ª—è Limit –æ—Ä–¥–µ—Ä–æ–≤  
‚úÖ TP/SL –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ —Ü–µ–Ω–µ –∏–ª–∏ –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É  
‚úÖ TP/SL –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø–∞–Ω–µ–ª–∏ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤  
‚úÖ –§–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏  
‚úÖ TP/SL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–µ–≤–æ–π —Ü–µ–Ω—ã  
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ TP/SL  
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å TP/SL –≤ —Ä–µ–∂–∏–º–µ Track  
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å TP/SL  
‚úÖ –ü—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ TP/SL –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏  

### –ù–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

‚úÖ –ü–∞–Ω–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è –∑–∞ < 1 —Å–µ–∫—É–Ω–¥—ã  
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∑–∞ < 5 —Å–µ–∫—É–Ω–¥  
‚úÖ TP/SL –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã  
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏  
‚úÖ –ö–æ–¥ –ø–æ–∫—Ä—ã—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º  
‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞  
‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TP/SL –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞  

---

## –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å TP/SL

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: Market Buy —Å TP/SL

**–î–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞
2. –í—ã–±—Ä–∞—Ç—å —Ä–µ–∂–∏–º Buy
3. –í—ã–±—Ä–∞—Ç—å —Å—É–º–º—É $50
4. –ù–∞–∂–∞—Ç—å `[üéØ Set TP]`
5. –í—ã–±—Ä–∞—Ç—å "By Percent"
6. –í–≤–µ—Å—Ç–∏ `20` (–¥–ª—è +20%)
7. –ù–∞–∂–∞—Ç—å `[üõ°Ô∏è Set SL]`
8. –í—ã–±—Ä–∞—Ç—å "By Percent"
9. –í–≤–µ—Å—Ç–∏ `10` (–¥–ª—è -10%)
10. –ù–∞–∂–∞—Ç—å `[üü¢ Execute Trade]`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ë–æ—Ç –ø–æ–∫—É–ø–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã
- –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–∑–∏—Ü–∏—è —Å TP = +20% –∏ SL = -10%
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –ü–æ–∑–∏—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP –∏–ª–∏ SL

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TP –≤–æ –≤—Ä–µ–º—è —Ç—Ä–µ–π–¥–∏–Ω–≥–∞

**–î–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
1. –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —Ç–æ–∫–µ–Ω–∞ (–ø–æ–∑–∏—Ü–∏—è —É–∂–µ –µ—Å—Ç—å)
2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ —Ä–µ–∂–∏–º Track
3. –í–∏–¥–µ—Ç—å —Ç–µ–∫—É—â–∏–π PNL: +$5.50 (+11%)
4. –ù–∞–∂–∞—Ç—å `[Edit TP: $2.50]`
5. –í—ã–±—Ä–∞—Ç—å "By Price"
6. –í–≤–µ—Å—Ç–∏ –Ω–æ–≤—É—é —Ü–µ–Ω—É `2.80`
7. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- TP –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ $2.80
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —Å –Ω–æ–≤–æ–π —Ü–µ–ª–µ–≤–æ–π —Ü–µ–Ω–æ–π
- –ü–∞–Ω–µ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π TP

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ Take Profit

**–ü—Ä–æ—Ü–µ—Å—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π):**
1. –ü–æ–∑–∏—Ü–∏—è: 100 —Ç–æ–∫–µ–Ω–æ–≤, –≤—Ö–æ–¥ $2.00, TP $2.40 (+20%)
2. –¶–µ–Ω–∞ —Ä–∞—Å—Ç–µ—Ç: $2.10 ‚Üí $2.25 ‚Üí $2.40
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç: current_price >= tp_price
4. –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–∞–µ—Ç –≤—Å–µ 100 —Ç–æ–∫–µ–Ω–æ–≤
5. –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "closed_tp"
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
```
üéØ Take Profit —Å—Ä–∞–±–æ—Ç–∞–ª!
–¢–æ–∫–µ–Ω: 4k3D...kX6R
–¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞: $2.41
PNL: +$41.00 (+20.5%)
TX: a4b8c2d1...
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ Stop Loss

**–ü—Ä–æ—Ü–µ—Å—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π):**
1. –ü–æ–∑–∏—Ü–∏—è: 100 —Ç–æ–∫–µ–Ω–æ–≤, –≤—Ö–æ–¥ $2.00, SL $1.80 (-10%)
2. –¶–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç: $1.95 ‚Üí $1.85 ‚Üí $1.80
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç: current_price <= sl_price
4. –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–∞–µ—Ç –≤—Å–µ 100 —Ç–æ–∫–µ–Ω–æ–≤
5. –ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "closed_sl"
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
```
üõ°Ô∏è Stop Loss —Å—Ä–∞–±–æ—Ç–∞–ª!
–¢–æ–∫–µ–Ω: 4k3D...kX6R
–¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞: $1.79
PNL: -$21.00 (-10.5%)
TX: b5c9d3e2...
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ edge-cases –¥–ª—è TP/SL

### 1. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –ø—Ä–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏

```python
async def execute_tp_sl_with_retry(position, action: str, max_retries: int = 3):
    """
    –í—ã–ø–æ–ª–Ω–∏—Ç—å TP/SL —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
    """
    for attempt in range(max_retries):
        try:
            # –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É
            tx_result = await execute_swap(
                token_address=position.token_address,
                amount_tokens=position.size,
                action="sell",
                slippage=1.0 + (attempt * 0.5)  # –£–≤–µ–ª–∏—á–∏—Ç—å slippage –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–∞—Ö
            )
            return tx_result
            
        except InsufficientLiquidityError as e:
            if attempt == max_retries - 1:
                # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
                logger.error(f"Failed to execute {action} after {max_retries} attempts: {e}")
                
                # –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await send_notification(
                    user_id=position.user_id,
                    text=f"‚ö†Ô∏è {action} –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.\n"
                         f"–ü–æ–∑–∏—Ü–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç–æ–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –≤—Ä—É—á–Ω—É—é."
                )
                raise
            
            # –ü–æ–¥–æ–∂–¥–∞—Ç—å –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
            await asyncio.sleep(2)
            logger.warning(f"{action} attempt {attempt + 1} failed, retrying...")
```

### 2. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ TP –∏ SL (–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)

```python
async def check_tp_sl_collision(position, current_price: float):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ
    """
    tp_triggered = position.tp_enabled and current_price >= position.tp_price
    sl_triggered = position.sl_enabled and current_price <= position.sl_price
    
    if tp_triggered and sl_triggered:
        # –≠—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö
        logger.error(f"Position {position.id}: TP and SL both triggered!")
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: SL (–∑–∞—â–∏—Ç–∞ –∫–∞–ø–∏—Ç–∞–ª–∞ –≤–∞–∂–Ω–µ–µ)
        return "sl"
    elif tp_triggered:
        return "tp"
    elif sl_triggered:
        return "sl"
    else:
        return None
```

### 3. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –≤–æ –≤—Ä–µ–º—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

```python
async def execute_with_price_check(position, expected_price: float, tolerance: float = 0.02):
    """
    –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–¥–µ–ª–∫—É —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏—è —Ü–µ–Ω—ã
    """
    # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ–º
    pre_tx_price = await get_token_price(position.token_address)
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ —É—à–ª–∞ –ª–∏ —Ü–µ–Ω–∞ —Å–∏–ª—å–Ω–æ –≤ –¥—Ä—É–≥—É—é —Å—Ç–æ—Ä–æ–Ω—É
    price_diff_percent = abs(pre_tx_price - expected_price) / expected_price
    
    if price_diff_percent > tolerance:
        logger.warning(
            f"Price moved significantly before execution: "
            f"expected={expected_price}, actual={pre_tx_price}"
        )
        
        # –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await send_notification(
            user_id=position.user_id,
            text=f"‚ö†Ô∏è –¶–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –Ω–∞ {price_diff_percent*100:.1f}% –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ–º.\n"
                 f"–û–∂–∏–¥–∞–µ–º–∞—è: ${expected_price:.4f}\n"
                 f"–¢–µ–∫—É—â–∞—è: ${pre_tx_price:.4f}\n"
                 f"–í—ã–ø–æ–ª–Ω—è—é —Å–¥–µ–ª–∫—É..."
        )
    
    # –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    return await execute_swap(
        token_address=position.token_address,
        amount_tokens=position.size,
        action="sell"
    )
```

### 4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞

```python
async def restore_tp_sl_monitoring():
    """
    –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TP/SL –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
    """
    # –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Å TP/SL
    active_positions = await get_active_positions_with_tp_sl()
    
    logger.info(f"Restoring TP/SL monitoring for {len(active_positions)} positions")
    
    for position in active_positions:
        try:
            # –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
            await tp_sl_monitor.start_monitor(position.id)
            logger.info(f"Restored monitoring for position {position.id}")
            
        except Exception as e:
            logger.error(f"Failed to restore monitoring for position {position.id}: {e}")

# –í—ã–∑—ã–≤–∞—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞
async def on_bot_startup():
    """
    –î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
    """
    logger.info("Bot starting up...")
    
    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    await restore_tp_sl_monitoring()
    
    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–∏–º–∏—Ç–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
    await restore_limit_order_monitoring()
    
    logger.info("Bot startup complete")
```

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ TP/SL

### –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–æ —Ç–æ–∫–µ–Ω–∞–º

–í–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞:

```python
class OptimizedTPSLMonitor:
    """
    –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TP/SL —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ —Ç–æ–∫–µ–Ω–∞–º
    """
    
    def __init__(self):
        self.token_monitors = {}  # token_address -> Task
        self.positions_by_token = {}  # token_address -> [position_ids]
    
    async def start_monitor(self, position_id: int):
        """
        –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        """
        position = await get_position(position_id)
        token_address = position.token_address
        
        # –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
        if token_address not in self.positions_by_token:
            self.positions_by_token[token_address] = []
        
        if position_id not in self.positions_by_token[token_address]:
            self.positions_by_token[token_address].append(position_id)
        
        # –ï—Å–ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –µ—â–µ –Ω–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∞, —Å–æ–∑–¥–∞—Ç—å
        if token_address not in self.token_monitors:
            task = asyncio.create_task(self._monitor_token(token_address))
            self.token_monitors[token_address] = task
    
    async def stop_monitor(self, position_id: int):
        """
        –£–±—Ä–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –∏–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        """
        position = await get_position(position_id)
        token_address = position.token_address
        
        if token_address in self.positions_by_token:
            if position_id in self.positions_by_token[token_address]:
                self.positions_by_token[token_address].remove(position_id)
            
            # –ï—Å–ª–∏ –±–æ–ª—å—à–µ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–∫–µ–Ω–∞, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä
            if not self.positions_by_token[token_address]:
                if token_address in self.token_monitors:
                    self.token_monitors[token_address].cancel()
                    del self.token_monitors[token_address]
                del self.positions_by_token[token_address]
    
    async def _monitor_token(self, token_address: str):
        """
        –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
        """
        try:
            while True:
                # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –û–î–ò–ù —Ä–∞–∑ –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π —ç—Ç–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
                current_price = await get_token_price(token_address)
                
                # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —ç—Ç–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
                position_ids = self.positions_by_token.get(token_address, [])
                
                for position_id in position_ids[:]:  # –ö–æ–ø–∏—è —Å–ø–∏—Å–∫–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
                    try:
                        position = await get_position(position_id)
                        
                        if not position or position.status != "active":
                            # –£–±—Ä–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
                            await self.stop_monitor(position_id)
                            continue
                        
                        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TP
                        if position.tp_enabled and current_price >= position.tp_price:
                            await self._execute_take_profit(position, current_price)
                            await self.stop_monitor(position_id)
                            continue
                        
                        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SL
                        if position.sl_enabled and current_price <= position.sl_price:
                            await self._execute_stop_loss(position, current_price)
                            await self.stop_monitor(position_id)
                            continue
                            
                    except Exception as e:
                        logger.error(f"Error checking position {position_id}: {e}")
                
                # –ü–æ–¥–æ–∂–¥–∞—Ç—å –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
                await asyncio.sleep(2)
                
        except asyncio.CancelledError:
            pass
        except Exception as e:
            logger.error(f"Error monitoring token {token_address}: {e}")
    
    async def _execute_take_profit(self, position, current_price: float):
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å Take Profit"""
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π
        pass
    
    async def _execute_stop_loss(self, position, current_price: float):
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å Stop Loss"""
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π
        pass

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä
tp_sl_monitor = OptimizedTPSLMonitor()
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –û–¥–∏–Ω RPC –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ç–æ–∫–µ–Ω –≤–º–µ—Å—Ç–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é
- –ú–µ–Ω—å—à–µ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á (–æ–¥–Ω–∞ –Ω–∞ —Ç–æ–∫–µ–Ω –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–π –Ω–∞ –ø–æ–∑–∏—Ü–∏—é)
- –ë–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

---

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```python
class NotificationService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
    """
    
    @staticmethod
    async def send_tp_executed(user_id: int, position, tx_result):
        """
        –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ Take Profit
        """
        pnl_percent = (position.pnl_usd / position.entry_value_usd) * 100
        
        text = (
            "üéØ <b>Take Profit Executed!</b>\n\n"
            f"Token: <code>{position.token_address[:8]}...</code>\n"
            f"Entry Price: ${position.entry_price:.4f}\n"
            f"Exit Price: ${tx_result['execution_price']:.4f}\n"
            f"Size: {position.size:.2f} tokens\n\n"
            f"üí∞ PNL: <b>${position.pnl_usd:+.2f}</b> ({pnl_percent:+.1f}%)\n\n"
            f"TX: <a href='https://solscan.io/tx/{tx_result['signature']}'>View</a>"
        )
        
        await bot.send_message(
            chat_id=user_id,
            text=text,
            parse_mode="HTML",
            disable_web_page_preview=True
        )
    
    @staticmethod
    async def send_sl_executed(user_id: int, position, tx_result):
        """
        –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ Stop Loss
        """
        pnl_percent = (position.pnl_usd / position.entry_value_usd) * 100
        
        text = (
            "üõ°Ô∏è <b>Stop Loss Executed</b>\n\n"
            f"Token: <code>{position.token_address[:8]}...</code>\n"
            f"Entry Price: ${position.entry_price:.4f}\n"
            f"Exit Price: ${tx_result['execution_price']:.4f}\n"
            f"Size: {position.size:.2f} tokens\n\n"
            f"üìâ PNL: <b>${position.pnl_usd:+.2f}</b> ({pnl_percent:+.1f}%)\n\n"
            f"TX: <a href='https://solscan.io/tx/{tx_result['signature']}'>View</a>"
        )
        
        await bot.send_message(
            chat_id=user_id,
            text=text,
            parse_mode="HTML",
            disable_web_page_preview=True
        )
    
    @staticmethod
    async def send_tp_sl_approaching(user_id: int, position, current_price: float, 
                                     target_type: str, distance_percent: float):
        """
        –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ TP/SL
        """
        if target_type == "tp":
            text = (
                "üéØ <b>Approaching Take Profit</b>\n\n"
                f"Token: <code>{position.token_address[:8]}...</code>\n"
                f"Current Price: ${current_price:.4f}\n"
                f"Target Price: ${position.tp_price:.4f}\n"
                f"Distance: {distance_percent:.1f}%"
            )
        else:  # sl
            text = (
                "üõ°Ô∏è <b>Approaching Stop Loss</b>\n\n"
                f"Token: <code>{position.token_address[:8]}...</code>\n"
                f"Current Price: ${current_price:.4f}\n"
                f"Target Price: ${position.sl_price:.4f}\n"
                f"Distance: {distance_percent:.1f}%"
            )
        
        await bot.send_message(
            chat_id=user_id,
            text=text,
            parse_mode="HTML"
        )
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ —Ü–µ–ª—è–º

```python
async def _monitor_position_with_alerts(self, position_id: int):
    """
    –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏
    """
    alerts_sent = {"tp_5": False, "tp_2": False, "sl_5": False, "sl_2": False}
    
    while True:
        position = await get_position(position_id)
        current_price = await get_token_price(position.token_address)
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TP
        if position.tp_enabled:
            distance_to_tp = ((position.tp_price - current_price) / current_price) * 100
            
            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ 5% –¥–æ —Ü–µ–ª–∏
            if 0 < distance_to_tp <= 5 and not alerts_sent["tp_5"]:
                await NotificationService.send_tp_sl_approaching(
                    position.user_id, position, current_price, "tp", distance_to_tp
                )
                alerts_sent["tp_5"] = True
            
            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ 2% –¥–æ —Ü–µ–ª–∏
            if 0 < distance_to_tp <= 2 and not alerts_sent["tp_2"]:
                await NotificationService.send_tp_sl_approaching(
                    position.user_id, position, current_price, "tp", distance_to_tp
                )
                alerts_sent["tp_2"] = True
            
            # –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ
            if current_price >= position.tp_price:
                await self._execute_take_profit(position, current_price)
                break
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SL (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
        if position.sl_enabled:
            distance_to_sl = ((current_price - position.sl_price) / current_price) * 100
            
            if 0 < distance_to_sl <= 5 and not alerts_sent["sl_5"]:
                await NotificationService.send_tp_sl_approaching(
                    position.user_id, position, current_price, "sl", distance_to_sl
                )
                alerts_sent["sl_5"] = True
            
            if 0 < distance_to_sl <= 2 and not alerts_sent["sl_2"]:
                await NotificationService.send_tp_sl_approaching(
                    position.user_id, position, current_price, "sl", distance_to_sl
                )
                alerts_sent["sl_2"] = True
            
            if current_price <= position.sl_price:
                await self._execute_stop_loss(position, current_price)
                break
        
        await asyncio.sleep(2)
```

---

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞—É–¥–∏—Ç–∞

```python
class TPSLAuditLogger:
    """
    –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π TP/SL –¥–ª—è –∞—É–¥–∏—Ç–∞
    """
    
    @staticmethod
    async def log_tp_sl_set(user_id: int, position_id: int, tp_price: float = None, 
                           sl_price: float = None):
        """
        –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É TP/SL
        """
        event = {
            "timestamp": datetime.now().isoformat(),
            "event_type": "tp_sl_set",
            "user_id": user_id,
            "position_id": position_id,
            "tp_price": tp_price,
            "sl_price": sl_price
        }
        await save_audit_log(event)
    
    @staticmethod
    async def log_tp_sl_triggered(position_id: int, trigger_type: str, 
                                  trigger_price: float, execution_price: float):
        """
        –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ TP/SL
        """
        event = {
            "timestamp": datetime.now().isoformat(),
            "event_type": f"{trigger_type}_triggered",
            "position_id": position_id,
            "trigger_price": trigger_price,
            "execution_price": execution_price,
            "slippage": abs(execution_price - trigger_price) / trigger_price * 100
        }
        await save_audit_log(event)
    
    @staticmethod
    async def log_tp_sl_execution_failed(position_id: int, trigger_type: str, 
                                        error: str):
        """
        –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è TP/SL
        """
        event = {
            "timestamp": datetime.now().isoformat(),
            "event_type": f"{trigger_type}_failed",
            "position_id": position_id,
            "error": str(error)
        }
        await save_audit_log(event)
```

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è TP/SL

–î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ TP/SL:

```python
class UserPreferences:
    """
    –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    user_id: int
    
    # –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ TP/SL
    default_tp_enabled: bool = False
    default_tp_percent: float = 20.0
    
    default_sl_enabled: bool = False
    default_sl_percent: float = 10.0
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    notify_tp_approaching: bool = True
    notify_sl_approaching: bool = True
    notify_on_execution: bool = True
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    monitoring_interval_seconds: int = 2
    enable_trailing_sl: bool = False


async def apply_default_tp_sl(user_state: dict):
    """
    –ü—Ä–∏–º–µ–Ω–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ TP/SL –∏–∑ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    prefs = await get_user_preferences(user_state["user_id"])
    
    if prefs.default_tp_enabled:
        current_price = user_state["token_data"]["current_price"]
        tp_price = current_price * (1 + prefs.default_tp_percent / 100)
        
        user_state["action_data"]["tp_enabled"] = True
        user_state["action_data"]["tp_price"] = tp_price
        user_state["action_data"]["tp_percent"] = prefs.default_tp_percent
    
    if prefs.default_sl_enabled:
        current_price = user_state["token_data"]["current_price"]
        sl_price = current_price * (1 - prefs.default_sl_percent / 100)
        
        user_state["action_data"]["sl_enabled"] = True
        user_state["action_data"]["sl_price"] = sl_price
        user_state["action_data"]["sl_percent"] = -prefs.default_sl_percent
```

–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

```
/settings
```

**–ú–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫:**

```
‚öôÔ∏è Settings

Default Take Profit: ‚úÖ Enabled (+20%)
Default Stop Loss: ‚úÖ Enabled (-10%)

[Edit Default TP]
[Edit Default SL]
[Disable Defaults]

Notifications:
‚úÖ Approaching alerts
‚úÖ Execution alerts

[Toggle Notifications]
[‚ùå Close]
```

---

## –§–∏–Ω–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–ó–∞—â–∏—Ç–∞ –æ—Ç –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ —Ü–µ–Ω—ã –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–Ω–µ –æ–¥–∏–Ω RPC endpoint)
2. **Rate limiting:** –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏/–∏–∑–º–µ–Ω–µ–Ω–∏—è TP/SL (–º–∞–∫—Å 5 —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É)
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ TP –≤—ã—à–µ, –∞ SL –Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

1. **Batch processing:** –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—É—é —Ü–µ–Ω—É –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ –æ–¥–Ω–æ–º —Ü–∏–∫–ª–µ
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î:** –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `status`, `token_address`, `tp_enabled`, `sl_enabled`

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã

–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π —Å TP/SL
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è TP/SL
- –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–π
- –°—Ä–µ–¥–Ω–∏–π slippage –ø—Ä–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏

---

## –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

**–û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –ø–æ –∞–¥—Ä–µ—Å—É —Ç–æ–∫–µ–Ω–∞
- [ ] 4 —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã (Buy/Sell/Limit/Track)
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç–æ–∫–µ–Ω–∞
- [ ] –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**TP/SL –¥–ª—è Market –æ—Ä–¥–µ—Ä–æ–≤:**
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ TP –ø–æ —Ü–µ–Ω–µ
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ TP –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SL –ø–æ —Ü–µ–Ω–µ
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SL –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É
- [ ] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ TP/SL –≤ UI
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å TP/SL –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏
- [ ] –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ TP/SL

**TP/SL –¥–ª—è Limit –æ—Ä–¥–µ—Ä–æ–≤:**
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ TP/SL –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–Ω–æ—Å TP/SL –≤ –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
- [ ] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ TP/SL –≤ —Ä–µ–∂–∏–º–µ Limit

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:**
- [ ] –§–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ TP/SL
- [ ] –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–æ —Ç–æ–∫–µ–Ω–∞–º
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ TP
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ SL
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏
- [ ] –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–†–µ–∂–∏–º Track:**
- [ ] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ PNL
- [ ] –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TP/SL
- [ ] –û—Ç–∫–ª—é—á–µ–Ω–∏–µ TP/SL
- [ ] –†—É—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏
- [ ] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ —Ü–µ–ª–µ–π

**–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ TP
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ SL
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ —Ü–µ–ª—è–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:**
- [ ] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ TP/SL –≤ –ë–î
- [ ] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–ø–æ –∂–µ–ª–∞–Ω–∏—é):**
- [ ] Trailing Stop Loss
- [ ] Partial Take Profit
- [ ] –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ TP/SL
- [ ] –ú–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

**–î–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–¥–∞—á–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É. –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω—ã, –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã.**